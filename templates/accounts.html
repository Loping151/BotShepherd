{% extends "base.html" %}

{% block title %}账号管理 - BotShepherd{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-person-gear"></i> 账号管理</h1>
</div>

<!-- 账号状态卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-person text-primary"></i>
                    总账号数
                </h5>
                <h3 id="total-accounts">0</h3>
                <small class="text-muted">个账号</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-check-circle text-success"></i>
                    活跃账号/启用账号
                </h5>
                <h3 id="active-accounts">0</h3>
                <small class="text-muted">今日活跃/启用</small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-pause-circle text-warning"></i>
                    禁用账号
                </h5>
                <h3 id="disabled-accounts">0</h3>
                <small class="text-muted">个账号</small>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-clock text-info"></i>
                    今日活跃
                </h5>
                <h3 id="today-active">0</h3>
                <small class="text-muted">个账号</small>
            </div>
        </div>
    </div>
</div>

<!-- 账号列表 -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-list"></i>
                账号列表
            </h5>
            <div class="col-md-3">
                <input type="text" class="form-control" id="accountSearchInput" placeholder="按ID/名称/描述搜索..." onkeyup="filterAccountTable()">
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="accounts-table">
                <thead>
                    <tr>
                        <th>
                            <button class="btn btn-link btn-sm p-0 text-decoration-none sort-header" type="button" data-sort="account_id">
                                账号ID <span class="sort-indicator"></span>
                            </button>
                        </th>
                        <th>
                            <button class="btn btn-link btn-sm p-0 text-decoration-none sort-header" type="button" data-sort="name">
                                名称 <span class="sort-indicator"></span>
                            </button>
                        </th>
                        <th>
                            <button class="btn btn-link btn-sm p-0 text-decoration-none sort-header" type="button" data-sort="description">
                                描述 <span class="sort-indicator"></span>
                            </button>
                        </th>
                        <th>
                            <button class="btn btn-link btn-sm p-0 text-decoration-none sort-header" type="button" data-sort="enabled">
                                状态 <span class="sort-indicator"></span>
                            </button>
                        </th>
                        <th>
                            <button class="btn btn-link btn-sm p-0 text-decoration-none sort-header" type="button" data-sort="last_receive_time">
                                最后接收 <span class="sort-indicator"></span>
                            </button>
                        </th>
                        <th>
                            <button class="btn btn-link btn-sm p-0 text-decoration-none sort-header" type="button" data-sort="last_send_time">
                                最后发送 <span class="sort-indicator"></span>
                            </button>
                        </th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 动态加载 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 添加/编辑账号模态框 -->
<div class="modal fade" id="accountModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="accountModalTitle">添加账号</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="accountForm">
                    <div class="mb-3">
                        <label for="accountId" class="form-label">账号ID</label>
                        <input type="text" class="form-control" id="accountId" 
                               placeholder="123456789" required>
                        <div class="form-text">账号</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="accountName" class="form-label">账号名称</label>
                        <input type="text" class="form-control" id="accountName" 
                               placeholder="Bot_123456789" required>
                    </div>

                    <div class="mb-3">
                        <label for="accountDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="accountDescription" rows="2"
                                  placeholder="账号描述信息"></textarea>
                    </div>

                    <!-- 指令别名管理 -->
                    <div class="mb-3">
                        <label class="form-label">指令别名</label>
                        <div class="alert alert-info py-2">
                            <small><i class="bi bi-info-circle"></i> 为指令设置别名，格式：别名1，别名2 -> 目标指令。例如：yz -> #，想保留原指令需将原指令加入别名</small>
                        </div>
                        <div id="accountAliasesList">
                            <div class="alias-row input-group mb-2">
                            <input type="text" class="form-control alias-values" placeholder="别名（如：yz）">
                            <span class="input-group-text">→</span>
                            <input type="text" class="form-control alias-key" placeholder="目标指令（如：#）">
                            <button class="btn btn-outline-danger" type="button" onclick="removeAccountAlias(this)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addAccountAlias()">
                            <i class="bi bi-plus"></i>
                            添加别名
                        </button>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="accountEnabled" checked>
                            <label class="form-check-label" for="accountEnabled">
                                启用账号
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveAccount()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 账号详情模态框 -->
<div class="modal fade" id="accountDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">账号详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="accountDetailContent">
                    <!-- 动态加载 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let accounts = {};
let editingAccountId = null;
let sortState = { key: 'account_id', dir: 'asc' };

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadAccounts();
    initSortHandlers();
    // setInterval(loadAccounts, 30000); // 每30秒刷新
});

// 加载账号列表
async function loadAccounts() {
    try {
        const response = await apiRequest('/api/accounts');
        accounts = response;
        updateAccountStats();
        updateAccountTable();
    } catch (error) {
        console.error('加载账号失败:', error);
    }
}

// 更新账号统计
function updateAccountStats() {
    const total = Object.keys(accounts).length;
    let enabled = 0, disabled = 0, todayActive = 0;

    const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const today = new Date().toLocaleDateString('en-CA', { 
        timeZone: userTimeZone 
    });

    Object.values(accounts).forEach(account => {
        if (account.enabled) {
            enabled++;
        } else {
            disabled++;
        }

        // 检查今日是否活跃（基于last_send_time）
        if (account.last_send_time) {
            const accountDate = new Date(account.last_send_time)
                .toLocaleDateString('en-CA', { 
                    timeZone: userTimeZone 
                });
            
            if (accountDate === today) {
                todayActive++;
            }
        }
    });

    document.getElementById('total-accounts').textContent = total;
    document.getElementById('active-accounts').textContent = `${todayActive}/${enabled}`;
    document.getElementById('disabled-accounts').textContent = disabled;
    document.getElementById('today-active').textContent = todayActive;
}

// 更新账号表格
function updateAccountTable() {
    const tbody = document.querySelector('#accounts-table tbody');
    tbody.innerHTML = '';

    const sortedEntries = getSortedAccountEntries();
    sortedEntries.forEach(([accountId, account]) => {
        const row = document.createElement('tr');
        
        const statusBadge = account.enabled ? 
            '<span class="badge bg-success">启用</span>' : 
            '<span class="badge bg-secondary">禁用</span>';
        
        const lastReceive = account.last_receive_time ? 
            formatDateTime(account.last_receive_time) : '从未';
        const lastSend = account.last_send_time ? 
            formatDateTime(account.last_send_time) : '从未';
        
        row.innerHTML = `
            <td><code>${accountId}</code></td>
            <td>${account.name}</td>
            <td><small>${account.description || '无描述'}</small></td>
            <td>${statusBadge}</td>
            <td><small>${lastReceive}</small></td>
            <td><small>${lastSend}</small></td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-outline-primary" onclick="showAccountDetail('${accountId}')" title="查看详情">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="editAccount('${accountId}')" title="编辑">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-${account.enabled ? 'warning' : 'success'}" 
                            onclick="toggleAccount('${accountId}')" title="${account.enabled ? '禁用' : '启用'}">
                        <i class="bi bi-${account.enabled ? 'pause' : 'play'}"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAccount('${accountId}')" title="删除">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });

    updateSortIndicators();
    filterAccountTable();
}

// 格式化日期时间
function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '从未';
    
    const date = new Date(dateTimeStr);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffMins < 1) return '刚刚';
    if (diffMins < 60) return `${diffMins}分钟前`;
    if (diffHours < 24) return `${diffHours}小时前`;
    if (diffDays < 7) return `${diffDays}天前`;
    
    return date.toLocaleDateString('zh-CN');
}

// 编辑账号
function editAccount(accountId) {
    editingAccountId = accountId;
    const account = accounts[accountId];

    document.getElementById('accountModalTitle').textContent = '编辑账号';
    document.getElementById('accountId').value = accountId;
    document.getElementById('accountId').disabled = true;
    document.getElementById('accountName').value = account.name;
    document.getElementById('accountDescription').value = account.description || '';
    document.getElementById('accountEnabled').checked = account.enabled;

    // 加载指令别名
    loadAccountAliasesToForm(account.aliases || {});

    new bootstrap.Modal(document.getElementById('accountModal')).show();
}

// 保存账号
async function saveAccount() {
    try {
        const accountId = document.getElementById('accountId').value.trim();
        const name = document.getElementById('accountName').value.trim();
        const description = document.getElementById('accountDescription').value.trim();
        const enabled = document.getElementById('accountEnabled').checked;

        const aliasRows = document.querySelectorAll('.alias-row');
        const aliases = {};

        aliasRows.forEach(row => {
            const aliasValuesInput = row.querySelector('.alias-values');
            const targetInput = row.querySelector('.alias-key');

            if (aliasValuesInput && targetInput) {
                const aliasValues = aliasValuesInput.value.trim();
                const target = targetInput.value.trim();

                if (target && aliasValues) {
                    const aliasList = aliasValues.split(/[,，]/).map(v => v.trim()).filter(v => v);
                    if (aliasList.length > 0) {
                        aliases[target] = aliasList;
                    }
                }
            }
        });

        const accountData = {
            account_id: accountId,
            name: name,
            description: description,
            enabled: enabled,
            aliases: aliases,
        };

        await apiRequest(`/api/accounts/${accountId}`, {
            method: 'PUT',
            body: JSON.stringify(accountData)
        });

        showToast('账号更新成功', 'success');
        bootstrap.Modal.getInstance(document.getElementById('accountModal')).hide();
        loadAccounts();

    } catch (error) {
        showToast(`保存账号失败: ${error.message}`, 'danger');
    }
}

// 切换账号状态
async function toggleAccount(accountId) {
    try {
        const account = accounts[accountId];
        const newStatus = !account.enabled;
        
        const accountData = {
            ...account,
            enabled: newStatus
        };
        
        await apiRequest(`/api/accounts/${accountId}`, {
            method: 'PUT',
            body: JSON.stringify(accountData)
        });
        
        showToast(`账号已${newStatus ? '启用' : '禁用'}`, 'success');
        loadAccounts();
        
    } catch (error) {
        showToast(`切换账号状态失败: ${error.message}`, 'danger');
    }
}

// 删除账号
async function deleteAccount(accountId) {
    if (!confirm('确定要删除这个账号吗？')) {
        return;
    }
    
    try {
        await apiRequest(`/api/accounts/${accountId}`, {
            method: 'DELETE'
        });
        
        showToast('账号删除成功', 'success');
        loadAccounts();
    } catch (error) {
        showToast(`删除账号失败: ${error.message}`, 'danger');
    }
}

// 显示账号详情
function showAccountDetail(accountId) {
    const account = accounts[accountId];
    
    let formattedAliases = '无';
    if (account.aliases && Object.keys(account.aliases).length > 0) {
        formattedAliases = Object.entries(account.aliases).map(([target, aliasList]) => {
            return `<code>${aliasList.join(', ')}</code> → <code>${target}</code>`;
        }).join('<br>');
    }

    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>基本信息</h6>
                <table class="table table-sm">
                    <tr><td>账号ID</td><td><code>${accountId}</code></td></tr>
                    <tr><td>名称</td><td>${account.name}</td></tr>
                    
                    <tr><td>别名</td><td>${formattedAliases}</td></tr>
                    
                    <tr><td>描述</td><td>${account.description || '无'}</td></tr>
                    <tr><td>状态</td><td>${account.enabled ? '启用' : '禁用'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>活动信息</h6>
                <table class="table table-sm">
                    <tr><td>最后接收</td><td>${account.last_receive_time ? formatDateTime(account.last_receive_time) : '从未'}</td></tr>
                    <tr><td>最后发送</td><td>${account.last_send_time ? formatDateTime(account.last_send_time) : '从未'}</td></tr>
                </table>
            </div>
        </div>
    `;
    
    document.getElementById('accountDetailContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('accountDetailModal')).show();
}

// 添加账号别名
function addAccountAlias() {
    const list = document.getElementById('accountAliasesList');
    const div = document.createElement('div');
    div.className = 'alias-row input-group mb-2';
    div.innerHTML = `
        <input type="text" class="form-control alias-values" placeholder="别名（如：yun）">
        <span class="input-group-text">→</span>
        <input type="text" class="form-control alias-key" placeholder="目标指令（如：#）">
        <button class="btn btn-outline-danger" type="button" onclick="removeAccountAlias(this)">
                <i class="bi bi-trash"></i>
        </button>
    `;
    list.appendChild(div);
}

// 移除账号别名
function removeAccountAlias(button) {
    const list = document.getElementById('accountAliasesList');
    if (list.children.length > 1) {
        button.parentElement.remove();
    }
}

// 重置账号别名列表
function resetAccountAliasesList() {
    const list = document.getElementById('accountAliasesList');
    list.innerHTML = `
        <div class="alias-row input-group mb-2">
            <input type="text" class="form-control alias-values" placeholder="别名（如：yz）">
            <span class="input-group-text">→</span>
            <input type="text" class="form-control alias-key" placeholder="目标指令（如：#）">
            <button class="btn btn-outline-danger" type="button" onclick="removeAccountAlias(this)">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
}

// 加载账号别名到表单
function loadAccountAliasesToForm(aliases) {
    const list = document.getElementById('accountAliasesList');
    list.innerHTML = '';

    if (!aliases || Object.keys(aliases).length === 0) {
        resetAccountAliasesList();
        return;
    }

    // 将别名对象转换为表单项
    Object.entries(aliases).forEach(([target, aliasList]) => {
        const div = document.createElement('div');
        div.className = 'alias-row input-group mb-2';
        div.innerHTML = `
            <input type="text" class="form-control alias-values" value="${aliasList.join(', ')}">
            <span class="input-group-text">→</span>
            <input type="text" class="form-control alias-key" value="${target}">
            <button class="btn btn-outline-danger" type="button" onclick="removeAccountAlias(this)">
                <i class="bi bi-trash"></i>
            </button>
        `;
        list.appendChild(div);
    });

    // 如果没有别名，至少显示一个空的输入框
    if (list.children.length === 0) {
        resetAccountAliasesList();
    }
}

// 账号排序相关函数
function initSortHandlers() {
    document.querySelectorAll('[data-sort]').forEach((element) => {
        element.addEventListener('click', () => {
            setSort(element.dataset.sort);
        });
    });
    updateSortIndicators();
}

function defaultSortDir(key) {
    return ['last_receive_time', 'last_send_time'].includes(key) ? 'desc' : 'asc';
}

function setSort(key) {
    if (sortState.key === key) {
        sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
    } else {
        sortState.key = key;
        sortState.dir = defaultSortDir(key);
    }
    updateAccountTable();
}

function parseDateValue(value) {
    const ts = Date.parse(value);
    return Number.isNaN(ts) ? 0 : ts;
}

function getSortValue(accountId, account, key) {
    if (key === 'account_id') {
        const num = Number(accountId);
        return Number.isFinite(num) ? num : String(accountId);
    }
    if (key === 'name') {
        return account.name || '';
    }
    if (key === 'description') {
        return account.description || '';
    }
    if (key === 'last_receive_time') {
        return account.last_receive_time ? parseDateValue(account.last_receive_time) : 0;
    }
    if (key === 'last_send_time') {
        return account.last_send_time ? parseDateValue(account.last_send_time) : 0;
    }
    if (key === 'enabled') {
        return account.enabled ? 1 : 0;
    }
    return 0;
}

function getSortedAccountEntries() {
    const entries = Object.entries(accounts);
    const key = sortState.key;
    entries.sort((a, b) => {
        const [aId, aAccount] = a;
        const [bId, bAccount] = b;
        const aVal = getSortValue(aId, aAccount, key);
        const bVal = getSortValue(bId, bAccount, key);
        let result = 0;

        if (typeof aVal === 'string' || typeof bVal === 'string') {
            result = String(aVal).localeCompare(String(bVal), 'zh-CN', { numeric: true, sensitivity: 'base' });
        } else {
            result = aVal - bVal;
        }

        return sortState.dir === 'asc' ? result : -result;
    });
    return entries;
}

function updateSortIndicators() {
    document.querySelectorAll('[data-sort]').forEach((element) => {
        const indicator = element.querySelector('.sort-indicator');
        if (!indicator) {
            return;
        }
        if (element.dataset.sort === sortState.key) {
            indicator.textContent = sortState.dir === 'asc' ? '^' : 'v';
        } else {
            indicator.textContent = '';
        }
    });
}

// 账号搜索过滤函数
function filterAccountTable() {
    const searchInput = document.getElementById('accountSearchInput');
    const filter = searchInput.value.toLowerCase();
    const table = document.getElementById('accounts-table');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        if (cells.length >= 3) {
            const accountId = (cells[0].textContent || cells[0].innerText).toLowerCase();
            const name = (cells[1].textContent || cells[1].innerText).toLowerCase();
            const description = (cells[2].textContent || cells[2].innerText).toLowerCase();

            if (accountId.indexOf(filter) > -1 ||
                name.indexOf(filter) > -1 ||
                description.indexOf(filter) > -1) {
                rows[i].style.display = '';
            } else {
                rows[i].style.display = 'none';
            }
        }
    }
}
</script>
{% endblock %}
