{% extends "base.html" %}

{% block title %}ç»Ÿè®¡åˆ†æ - BotShepherd{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="bi bi-graph-up"></i> ç»Ÿè®¡åˆ†æ</h1>
        <small class="text-muted">æ‰€æœ‰æ—¶é—´å‡ä¸º UTC æ—¶é—´</small>
    </div>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" onclick="refreshStats()">
            <i class="bi bi-arrow-clockwise"></i>
            åˆ·æ–°
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="exportStats()">
            <i class="bi bi-download"></i>
            å¯¼å‡º
        </button>
    </div>
</div>

<!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-md-3">
                <label for="dateRange" class="form-label">æ—¶é—´èŒƒå›´</label>
                <select class="form-select" id="dateRange" onchange="updateDateRange()">
                    <option value="today">ä»Šå¤©</option>
                    <option value="yesterday">æ˜¨å¤©</option>
                    <option value="week" selected>æœ€è¿‘7å¤©</option>
                    <option value="month">æœ€è¿‘30å¤©</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
            </div>
            <div class="col-md-3" id="customDateRange" style="display: none;">
                <label for="startDate" class="form-label">å¼€å§‹æ—¥æœŸ</label>
                <input type="date" class="form-control" id="startDate">
            </div>
            <div class="col-md-3" id="customDateRange2" style="display: none;">
                <label for="endDate" class="form-label">ç»“æŸæ—¥æœŸ</label>
                <input type="date" class="form-control" id="endDate">
            </div>
            <div class="col-md-3">
                <label for="accountFilter" class="form-label">è´¦å·ç­›é€‰</label>
                <select class="form-select" id="accountFilter" onchange="loadStatistics()">
                    <option value="">å…¨éƒ¨è´¦å·</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-chat-dots text-primary"></i>
                    å‘é€æ¶ˆæ¯æ•°
                </h5>
                <h3 id="total-messages">0</h3>
                <small class="text-muted" id="messages-change">ä¸æ˜¨æ—¥å¯¹æ¯”</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-people text-success"></i>
                    æ´»è·ƒç”¨æˆ·
                </h5>
                <h3 id="active-users">0</h3>
                <small class="text-muted" id="users-change">ä¸æ˜¨æ—¥å¯¹æ¯”</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-collection text-info"></i>
                    æ´»è·ƒç¾¤ç»„
                </h5>
                <h3 id="active-groups">0</h3>
                <small class="text-muted" id="groups-change">ä¸æ˜¨æ—¥å¯¹æ¯”</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-chat-dots text-warning"></i>
                    æ”¶åˆ°çš„æ¶ˆæ¯æ€»é‡
                </h5>
                <h3 id="received-messages">0</h3>
                <small class="text-muted" id="received-change">ä¸æ˜¨æ—¥å¯¹æ¯”</small>
            </div>
        </div>
    </div>
</div>

<!-- å›¾è¡¨åŒºåŸŸ -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up"></i>
                    æ¶ˆæ¯è¶‹åŠ¿å›¾
                </h5>
            </div>
            <div class="card-body" style="height: 400px;">
                <canvas id="messagesTrendChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-pie-chart"></i>
                    æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ
                </h5>
            </div>
            <div class="card-body" style="height: 400px;">
                <canvas id="messageTypeChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- ç¾¤ç»„æ´»è·ƒåº¦æ’è¡Œ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-trophy"></i>
                    ç¾¤ç»„æ´»è·ƒåº¦æ’è¡Œ
                </h5>
                <small class="text-muted">æ‰€æœ‰æ´»è·ƒç¾¤ç»„æŒ‰æ¶ˆæ¯æ•°é‡æ’åº</small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="top-groups-table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>ç¾¤ç»„ID</th>
                                <th>æ¶ˆæ¯æ•°é‡</th>
                                <th>æ´»è·ƒåº¦</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- åŠ¨æ€åŠ è½½ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let messagesTrendChart, messageTypeChart;
let currentStats = {};

// UTCæ—¶é—´å·¥å…·å‡½æ•°
function getUTCDateString(date = new Date()) {
    return date.toISOString().split('T')[0];
}

function getUTCDateTime(date = new Date()) {
    return date.toISOString();
}

function formatUTCTime(dateString) {
    const date = new Date(dateString);
    return date.toISOString().replace('T', ' ').replace(/\.\d{3}Z$/, ' UTC');
}

function getCurrentUTCDate() {
    return new Date().toISOString().split('T')[0];
}

function getYesterdayUTCDate() {
    const yesterday = new Date();
    yesterday.setUTCDate(yesterday.getUTCDate() - 1);
    return yesterday.toISOString().split('T')[0];
}

function getUTCDateBefore(days) {
    const date = new Date();
    date.setUTCDate(date.getUTCDate() - days);
    return date.toISOString().split('T')[0];
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    loadAccounts();
    loadStatistics();

    // å®šæ—¶åˆ·æ–°
    setInterval(() => {
        loadStatistics();
    }, 60000); // æ¯åˆ†é’Ÿåˆ·æ–°
});

// åˆå§‹åŒ–å›¾è¡¨
function initCharts() {
    // æ¶ˆæ¯è¶‹åŠ¿å›¾ï¼ˆæ¯3å°æ—¶ï¼‰
    const trendCtx = document.getElementById('messagesTrendChart').getContext('2d');
    messagesTrendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'æ¯3å°æ—¶å‘é€é‡',
                data: [],
                borderColor: '#6c757d',
                backgroundColor: 'rgba(108, 117, 125, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'æ¶ˆæ¯æ•°é‡'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'æ—¶é—´ï¼ˆæ¯3å°æ—¶ï¼‰'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        }
                    }
                }
            }
        }
    });
    
    // æ¶ˆæ¯ç±»å‹åˆ†å¸ƒå›¾
    const typeCtx = document.getElementById('messageTypeChart').getContext('2d');
    messageTypeChart = new Chart(typeCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#6c757d',
                    '#495057',
                    '#28a745',
                    '#17a2b8',
                    '#ffc107',
                    '#dc3545',
                    '#fd7e14',
                    '#e83e8c'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// åŠ è½½è´¦å·åˆ—è¡¨
async function loadAccounts() {
    try {
        const accounts = await apiRequest('/api/accounts');
        const select = document.getElementById('accountFilter');
        
        // æ¸…ç©ºç°æœ‰é€‰é¡¹
        select.innerHTML = '<option value="">å…¨éƒ¨è´¦å·</option>';
        
        // æ·»åŠ è´¦å·é€‰é¡¹
        Object.entries(accounts).forEach(([accountId, account]) => {
            const option = document.createElement('option');
            option.value = accountId;
            option.textContent = `${account.name} (${accountId})`;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('åŠ è½½è´¦å·åˆ—è¡¨å¤±è´¥:', error);
    }
}

// åŠ è½½ç»Ÿè®¡æ•°æ®
async function loadStatistics() {
    try {
        const params = new URLSearchParams();
        
        // æ·»åŠ æ—¶é—´èŒƒå›´å‚æ•°ï¼ˆUTCï¼‰
        const dateRange = document.getElementById('dateRange').value;
        if (dateRange === 'custom') {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
        } else {
            params.append('range', dateRange);
        }
        
        // æ·»åŠ UTCæ—¶åŒºå‚æ•°
        params.append('timezone', 'UTC');
        
        // æ·»åŠ è´¦å·ç­›é€‰
        const accountFilter = document.getElementById('accountFilter').value;
        if (accountFilter) {
            params.append('self_id', accountFilter);
        }
        
        const stats = await apiRequest(`/api/statistics?${params.toString()}`);
        currentStats = stats;
        
        updateStatsCards(stats);
        updateCharts(stats);
        
    } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        showToast('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥', 'danger');
    }
}

// æ›´æ–°ç»Ÿè®¡å¡ç‰‡
function updateStatsCards(stats) {
    document.getElementById('total-messages').textContent = stats.total_messages || 0;
    document.getElementById('active-users').textContent = stats.active_users || 0;
    document.getElementById('active-groups').textContent = stats.active_groups || 0;
    document.getElementById('received-messages').textContent = stats.received_messages || 0;

    // æ›´æ–°å˜åŒ–æŒ‡ç¤ºå™¨
    updateChangeIndicator('messages-change', stats.messages_change);
    updateChangeIndicator('users-change', stats.users_change);
    updateChangeIndicator('groups-change', stats.groups_change);
    updateChangeIndicator('received-change', stats.received_change);
}

// æ›´æ–°å˜åŒ–æŒ‡ç¤ºå™¨
function updateChangeIndicator(elementId, change) {
    const element = document.getElementById(elementId);
    if (change === undefined || change === null) {
        element.textContent = 'ä¸æ˜¨æ—¥å¯¹æ¯”';
        element.className = 'text-muted';
        return;
    }

    const isPositive = change > 0;
    const icon = isPositive ? 'â†—' : 'â†˜';
    const color = isPositive ? 'text-success' : 'text-danger';

    element.className = `text-muted ${color}`;
    element.textContent = `${icon} ${Math.abs(change)}`;
}

// æ›´æ–°å›¾è¡¨
function updateCharts(stats) {
    // æ›´æ–°è¶‹åŠ¿å›¾ï¼ˆæ¯3å°æ—¶ï¼‰- ç¡®ä¿æ—¶é—´æ ‡ç­¾æ˜¾ç¤ºæ¸…æ™°
    if (stats.hourly_trend && stats.hourly_trend.length > 0) {
        messagesTrendChart.data.labels = stats.hourly_trend.map(item => item.time_label);
        messagesTrendChart.data.datasets[0].data = stats.hourly_trend.map(item => item.message_count);
        messagesTrendChart.update();
    }

    // æ›´æ–°æ¶ˆæ¯ç±»å‹åˆ†å¸ƒå›¾ - åŸºäºtop_groupsè®¡ç®—
    if (stats.top_groups && stats.total_messages) {
        const labels = [];
        const data = [];
        const colors = [];

        // è·å–å‰5åç¾¤ç»„
        const top10Groups = stats.top_groups.slice(0, 10);
        
        // è®¡ç®—ç¾¤èŠæ€»æ•°ï¼ˆæ‰€æœ‰ç¾¤ç»„çš„æ¶ˆæ¯æ€»å’Œï¼‰
        const totalGroupMessages = stats.top_groups.reduce((sum, group) => sum + group.message_count, 0);
        
        // è®¡ç®—ç§èŠæ•°é‡ï¼ˆæ€»æ¶ˆæ¯æ•° - ç¾¤èŠæ€»æ•°ï¼‰
        const privateMessages = Math.max(0, stats.total_messages - totalGroupMessages);
        
        // è®¡ç®—TOP5ç¾¤ç»„çš„æ¶ˆæ¯æ€»æ•°
        const top10TotalMessages = top10Groups.reduce((sum, group) => sum + group.message_count, 0);
        
        // è®¡ç®—å…¶ä»–ç¾¤ç»„çš„æ¶ˆæ¯æ•°é‡ï¼ˆæ€»ç¾¤èŠ - TOP5ç¾¤ç»„ï¼‰
        const otherGroupsMessages = Math.max(0, totalGroupMessages - top10TotalMessages);

        // 1. æ·»åŠ ç§èŠï¼ˆå¦‚æœæœ‰ï¼‰
        if (privateMessages > 0) {
            labels.push('ç§èŠ');
            data.push(privateMessages);
            colors.push('#28a745'); // ç»¿è‰²
        }

        // 2. æ·»åŠ TOP10ç¾¤ç»„
        const groupColors = ['#20c997', '#6f42c1', '#fd7e14', '#e83e8c', '#6610f2', '#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8'];   
        top10Groups.forEach((group, index) => {
            labels.push(`ç¾¤ç»„ ${group.group_id}`);
            data.push(group.message_count);
            colors.push(groupColors[index % groupColors.length]);
        });

        // 3. æ·»åŠ å…¶ä»–ç¾¤ç»„ï¼ˆå¦‚æœæœ‰ï¼‰
        if (otherGroupsMessages > 0) {
            labels.push('å…¶ä»–ç¾¤ç»„');
            data.push(otherGroupsMessages);
            colors.push('#6c757d'); // ç°è‰²
        }

        // 4. å¦‚æœæ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œæ˜¾ç¤ºå ä½ç¬¦
        if (labels.length === 0) {
            labels.push('æš‚æ— æ•°æ®');
            data.push(1);
            colors.push('#dee2e6');
        }

        // æ›´æ–°å›¾è¡¨
        messageTypeChart.data.labels = labels;
        messageTypeChart.data.datasets[0].data = data;
        messageTypeChart.data.datasets[0].backgroundColor = colors;
        messageTypeChart.update();
    }

    // æ›´æ–°ç¾¤ç»„æ’è¡Œè¡¨æ ¼
    updateTopGroupsTable(stats);
}

// ç¾¤ç»„æ´»è·ƒåº¦è¡¨æ ¼æ›´æ–°å‡½æ•° - æ˜¾ç¤ºæ‰€æœ‰ç¾¤ç»„
function updateTopGroupsTable(stats) {
    const table = document.querySelector('#top-groups-table tbody');
    table.innerHTML = '';

    if (stats.top_groups && stats.top_groups.length > 0) {
        const allGroups = stats.top_groups.slice(0, 20);
        
        const totalGroupMessages = stats.top_groups.reduce((sum, group) => sum + group.message_count, 0);
        const firstPlaceCount = allGroups[0] ? allGroups[0].message_count : 1;

        allGroups.forEach((group, index) => {
            const row = document.createElement('tr');

            // è®¡ç®—ç›¸å¯¹äºæ€»ç¾¤èŠæ¶ˆæ¯çš„ç™¾åˆ†æ¯”
            const percentOfTotal = totalGroupMessages > 0 ? 
                Math.round((group.message_count / totalGroupMessages) * 100) : 0;
            
            // è®¡ç®—ç›¸å¯¹äºç¬¬ä¸€åçš„ç™¾åˆ†æ¯”
            const percentOfFirst = Math.round((group.message_count / firstPlaceCount) * 100);

            // æ´»è·ƒåº¦è¿›åº¦æ¡é¢œè‰² - æ ¹æ®æ’ååˆ†é…é¢œè‰²
            let progressColor;
            let badgeColor;
            
            if (index === 0) {
                progressColor = 'bg-success';
                badgeColor = 'bg-warning';
            } else if (index === 1) {
                progressColor = 'bg-info';
                badgeColor = 'bg-secondary';
            } else if (index === 2) {
                progressColor = 'bg-warning';
                badgeColor = 'bg-secondary';
            } else if (index < 10) {
                progressColor = 'bg-primary';
                badgeColor = 'bg-secondary';
            } else {
                progressColor = 'bg-secondary';
                badgeColor = 'bg-light text-dark';
            }

            // ç‰¹æ®Šæ ‡è®°å‰ä¸‰å
            let rankDisplay = `#${index + 1}`;
            if (index === 0) rankDisplay = 'ğŸ¥‡ #1';
            else if (index === 1) rankDisplay = 'ğŸ¥ˆ #2';
            else if (index === 2) rankDisplay = 'ğŸ¥‰ #3';

            row.innerHTML = `
                <td>
                    <span class="badge ${badgeColor}">${rankDisplay}</span>
                </td>
                <td><code>${group.group_id}</code></td>
                <td>
                    <strong>${group.message_count.toLocaleString()}</strong><small class="text-muted"> | ${percentOfTotal}% æ€»é‡</small>
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar ${progressColor}" role="progressbar"
                             style="width: ${Math.max(percentOfFirst, 2)}%"
                             aria-valuenow="${percentOfFirst}" aria-valuemin="0" aria-valuemax="100">
                            ${percentOfFirst}%
                        </div>
                    </div>
                </td>
            `;

            // ä¸ºå‰ä¸‰åæ·»åŠ ç‰¹æ®Šæ ·å¼
            if (index < 3) {
                row.classList.add('table-light');
            }

            table.appendChild(row);
        });

    } else {
        // æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºæç¤º
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="4" class="text-center text-muted">
                <i class="bi bi-inbox"></i> æš‚æ— ç¾¤ç»„æ´»è·ƒæ•°æ®
            </td>
        `;
        table.appendChild(row);
    }
}


// æ›´æ–°æ—¥æœŸèŒƒå›´
function updateDateRange() {
    const dateRange = document.getElementById('dateRange').value;
    const customRange1 = document.getElementById('customDateRange');
    const customRange2 = document.getElementById('customDateRange2');
    
    if (dateRange === 'custom') {
        customRange1.style.display = 'block';
        customRange2.style.display = 'block';
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆUTCï¼‰
        const endDate = new Date();
        const startDate = new Date();
        startDate.setUTCDate(startDate.getUTCDate() - 7);
        
        document.getElementById('endDate').value = getUTCDateString(endDate);
        document.getElementById('startDate').value = getUTCDateString(startDate);
    } else {
        customRange1.style.display = 'none';
        customRange2.style.display = 'none';
    }
    
    loadStatistics();
}

// åˆ·æ–°ç»Ÿè®¡
function refreshStats() {
    loadStatistics();
    showToast('ç»Ÿè®¡æ•°æ®å·²åˆ·æ–°', 'success');
}

// å¯¼å‡ºç»Ÿè®¡
function exportStats() {
    if (!currentStats || Object.keys(currentStats).length === 0) {
        showToast('æš‚æ— æ•°æ®å¯å¯¼å‡º', 'warning');
        return;
    }
    
    try {
        // è·å–å½“å‰çš„ç­›é€‰å‚æ•°
        const dateRange = document.getElementById('dateRange').value;
        const accountFilter = document.getElementById('accountFilter').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        // åˆ›å»ºå¤šä¸ªCSVå†…å®¹
        const csvSections = [];
        
        // 1. åŸºç¡€ç»Ÿè®¡æ¦‚è§ˆ
        let overviewContent = "ç»Ÿè®¡æ¦‚è§ˆ\n";
        overviewContent += "æŒ‡æ ‡,æ•°å€¼\n";
        overviewContent += `å‘é€æ¶ˆæ¯æ•°,${currentStats.total_messages || 0}\n`;
        overviewContent += `æ´»è·ƒç”¨æˆ·æ•°,${currentStats.active_users || 0}\n`;
        overviewContent += `æ´»è·ƒç¾¤ç»„æ•°,${currentStats.active_groups || 0}\n`;
        overviewContent += `æ”¶åˆ°æ¶ˆæ¯æ•°,${currentStats.received_messages || 0}\n`;
        overviewContent += `ç»Ÿè®¡æ—¶é—´èŒƒå›´,${getDateRangeDescription()}\n`;
        overviewContent += `æ•°æ®å¯¼å‡ºæ—¶é—´,${formatUTCTime(new Date().toISOString())}\n`;
        if (accountFilter) {
            const accountName = document.querySelector(`#accountFilter option[value="${accountFilter}"]`)?.textContent || accountFilter;
            overviewContent += `è´¦å·ç­›é€‰,${accountName}\n`;
        }
        overviewContent += "\n";
        csvSections.push(overviewContent);
        
        // 2. æ—¶é—´è¶‹åŠ¿æ•°æ®ï¼ˆæ¯3å°æ—¶ï¼‰
        if (currentStats.hourly_trend && currentStats.hourly_trend.length > 0) {
            let trendContent = "æ—¶é—´è¶‹åŠ¿ï¼ˆæ¯3å°æ—¶ï¼‰\n";
            trendContent += "æ—¶é—´æ®µ,æ¶ˆæ¯æ•°é‡\n";
            currentStats.hourly_trend.forEach(item => {
                trendContent += `"${item.time_label}",${item.message_count}\n`;
            });
            trendContent += "\n";
            csvSections.push(trendContent);
        }
        
        // 3. ç¾¤ç»„æ´»è·ƒåº¦æ’è¡Œ
        if (currentStats.top_groups && currentStats.top_groups.length > 0) {
            let groupsContent = "ç¾¤ç»„æ´»è·ƒåº¦æ’è¡Œ\n";
            groupsContent += "æ’å,ç¾¤ç»„ID,æ¶ˆæ¯æ•°é‡,å æ€»é‡ç™¾åˆ†æ¯”\n";
            
            const totalGroupMessages = currentStats.top_groups.reduce((sum, group) => sum + group.message_count, 0);
            
            currentStats.top_groups.forEach((group, index) => {
                const percentage = totalGroupMessages > 0 ? 
                    ((group.message_count / totalGroupMessages) * 100).toFixed(2) : 0;
                groupsContent += `${index + 1},"${group.group_id}",${group.message_count},${percentage}%\n`;
            });
            groupsContent += "\n";
            csvSections.push(groupsContent);
        }
        
        // 4. å¦‚æœå­˜åœ¨daily_detailsï¼Œä¹ŸåŒ…å«è¿›å»
        if (currentStats.daily_details && currentStats.daily_details.length > 0) {
            let dailyContent = "æ¯æ—¥è¯¦ç»†æ•°æ®\n";
            dailyContent += "æ—¥æœŸ,æ¶ˆæ¯æ•°,ç”¨æˆ·æ•°,ç¾¤ç»„æ•°,æŒ‡ä»¤æ•°\n";
            currentStats.daily_details.forEach(day => {
                dailyContent += `${day.date},${day.messages || 0},${day.users || 0},${day.groups || 0},${day.commands || 0}\n`;
            });
            dailyContent += "\n";
            csvSections.push(dailyContent);
        }
        
        // 5. å¦‚æœå­˜åœ¨æ¶ˆæ¯ç±»å‹åˆ†å¸ƒæ•°æ®
        if (currentStats.message_types && Object.keys(currentStats.message_types).length > 0) {
            let typesContent = "æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ\n";
            typesContent += "æ¶ˆæ¯ç±»å‹,æ•°é‡,å æ¯”\n";
            const totalMessages = Object.values(currentStats.message_types).reduce((sum, count) => sum + count, 0);
            
            Object.entries(currentStats.message_types).forEach(([type, count]) => {
                const percentage = totalMessages > 0 ? ((count / totalMessages) * 100).toFixed(2) : 0;
                typesContent += `"${type}",${count},${percentage}%\n`;
            });
            typesContent += "\n";
            csvSections.push(typesContent);
        }
        
        // åˆå¹¶æ‰€æœ‰CSVå†…å®¹
        const fullCsvContent = csvSections.join("");
        
        // åˆ›å»ºBlobå¹¶ä¸‹è½½
        const blob = new Blob(['\ufeff' + fullCsvContent], { 
            type: 'text/csv;charset=utf-8;' 
        });
        
        // ç”Ÿæˆæ–‡ä»¶å
        const fileName = generateFileName();
        
        // ä½¿ç”¨ç°ä»£ä¸‹è½½æ–¹å¼
        if (window.navigator && window.navigator.msSaveOrOpenBlob) {
            // IEæµè§ˆå™¨
            window.navigator.msSaveOrOpenBlob(blob, fileName);
        } else {
            // ç°ä»£æµè§ˆå™¨
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // æ¸…ç†URLå¯¹è±¡
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }
        
        showToast(`ç»Ÿè®¡æ•°æ®å·²å¯¼å‡ºä¸º ${fileName}`, 'success');
        
    } catch (error) {
        console.error('å¯¼å‡ºç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        showToast('å¯¼å‡ºç»Ÿè®¡æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
    }
}

// ç”Ÿæˆæ–‡ä»¶åçš„è¾…åŠ©å‡½æ•°
function generateFileName() {
    const dateRange = document.getElementById('dateRange').value;
    const accountFilter = document.getElementById('accountFilter').value;
    const currentDate = getCurrentUTCDate();
    
    let fileName = `BotShepherd_ç»Ÿè®¡_${currentDate}_UTC`;
    
    // æ·»åŠ æ—¶é—´èŒƒå›´æ ‡è¯†
    switch(dateRange) {
        case 'today':
            fileName += '_ä»Šæ—¥';
            break;
        case 'yesterday':
            fileName += '_æ˜¨æ—¥';
            break;
        case 'week':
            fileName += '_7å¤©';
            break;
        case 'month':
            fileName += '_30å¤©';
            break;
        case 'custom':
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            if (start && end) {
                fileName += `_${start}_to_${end}`;
            } else {
                fileName += '_è‡ªå®šä¹‰';
            }
            break;
    }
    
    // æ·»åŠ è´¦å·æ ‡è¯†
    if (accountFilter) {
        fileName += `_è´¦å·${accountFilter}`;
    }
    
    return fileName + '.csv';
}

// è·å–æ—¥æœŸèŒƒå›´æè¿°çš„è¾…åŠ©å‡½æ•°
function getDateRangeDescription() {
    const dateRange = document.getElementById('dateRange').value;
    
    switch(dateRange) {
        case 'today':
            return `ä»Šæ—¥ (${getCurrentUTCDate()})`;
        case 'yesterday':
            return `æ˜¨æ—¥ (${getYesterdayUTCDate()})`;
        case 'week':
            return `æœ€è¿‘7å¤© (${getUTCDateBefore(7)} è‡³ ${getCurrentUTCDate()})`;
        case 'month':
            return `æœ€è¿‘30å¤© (${getUTCDateBefore(30)} è‡³ ${getCurrentUTCDate()})`;
        case 'custom':
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            if (start && end) {
                return `è‡ªå®šä¹‰èŒƒå›´ (${start} è‡³ ${end})`;
            } else {
                return 'è‡ªå®šä¹‰èŒƒå›´';
            }
        default:
            return 'æœªçŸ¥èŒƒå›´';
    }
}
</script>
{% endblock %}