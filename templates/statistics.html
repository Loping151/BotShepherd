{% extends "base.html" %}

{% block title %}统计分析 - BotShepherd{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="bi bi-graph-up"></i> 统计分析</h1>
        <small class="text-muted">所有时间均为 UTC 时间</small>
    </div>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-outline-primary" onclick="refreshStats()">
            <i class="bi bi-arrow-clockwise"></i>
            刷新
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="exportStats()">
            <i class="bi bi-download"></i>
            导出
        </button>
    </div>
</div>

<!-- 时间范围选择 -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-md-3">
                <label for="dateRange" class="form-label">时间范围</label>
                <select class="form-select" id="dateRange" onchange="updateDateRange()">
                    <option value="today">今天</option>
                    <option value="yesterday">昨天</option>
                    <option value="week" selected>最近7天</option>
                    <option value="month">最近30天</option>
                    <option value="custom">自定义</option>
                </select>
            </div>
            <div class="col-md-3" id="customDateRange" style="display: none;">
                <label for="startDate" class="form-label">开始日期</label>
                <input type="date" class="form-control" id="startDate">
            </div>
            <div class="col-md-3" id="customDateRange2" style="display: none;">
                <label for="endDate" class="form-label">结束日期</label>
                <input type="date" class="form-control" id="endDate">
            </div>
            <div class="col-md-3">
                <label for="accountFilter" class="form-label">账号筛选</label>
                <select class="form-select" id="accountFilter" onchange="loadStatistics()">
                    <option value="">全部账号</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- 统计概览卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-chat-dots text-primary"></i>
                    发送消息数
                </h5>
                <h3 id="total-messages">0</h3>
                <small class="text-muted" id="messages-change">与昨日对比</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-people text-success"></i>
                    活跃用户
                </h5>
                <h3 id="active-users">0</h3>
                <small class="text-muted" id="users-change">与昨日对比</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-collection text-info"></i>
                    活跃群组
                </h5>
                <h3 id="active-groups">0</h3>
                <small class="text-muted" id="groups-change">与昨日对比</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">
                    <i class="bi bi-chat-dots text-warning"></i>
                    收到的消息总量
                </h5>
                <h3 id="received-messages">0</h3>
                <small class="text-muted" id="received-change">与昨日对比</small>
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up"></i>
                    消息趋势图
                </h5>
            </div>
            <div class="card-body" style="height: 400px;">
                <canvas id="messagesTrendChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-pie-chart"></i>
                    消息类型分布
                </h5>
            </div>
            <div class="card-body" style="height: 400px;">
                <canvas id="messageTypeChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- 群组活跃度排行 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-trophy"></i>
                    群组活跃度排行
                </h5>
                <small class="text-muted">所有活跃群组按消息数量排序</small>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="top-groups-table">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>群组ID</th>
                                <th>消息数量</th>
                                <th>活跃度</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let messagesTrendChart, messageTypeChart;
let currentStats = {};

// UTC时间工具函数
function getUTCDateString(date = new Date()) {
    return date.toISOString().split('T')[0];
}

function getUTCDateTime(date = new Date()) {
    return date.toISOString();
}

function formatUTCTime(dateString) {
    const date = new Date(dateString);
    return date.toISOString().replace('T', ' ').replace(/\.\d{3}Z$/, ' UTC');
}

function getCurrentUTCDate() {
    return new Date().toISOString().split('T')[0];
}

function getYesterdayUTCDate() {
    const yesterday = new Date();
    yesterday.setUTCDate(yesterday.getUTCDate() - 1);
    return yesterday.toISOString().split('T')[0];
}

function getUTCDateBefore(days) {
    const date = new Date();
    date.setUTCDate(date.getUTCDate() - days);
    return date.toISOString().split('T')[0];
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    loadAccounts();
    loadStatistics();

    // 定时刷新
    setInterval(() => {
        loadStatistics();
    }, 60000); // 每分钟刷新
});

// 初始化图表
function initCharts() {
    // 消息趋势图（每3小时）
    const trendCtx = document.getElementById('messagesTrendChart').getContext('2d');
    messagesTrendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '每3小时发送量',
                data: [],
                borderColor: '#6c757d',
                backgroundColor: 'rgba(108, 117, 125, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '消息数量'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: '时间（每3小时）'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        }
                    }
                }
            }
        }
    });
    
    // 消息类型分布图
    const typeCtx = document.getElementById('messageTypeChart').getContext('2d');
    messageTypeChart = new Chart(typeCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#6c757d',
                    '#495057',
                    '#28a745',
                    '#17a2b8',
                    '#ffc107',
                    '#dc3545',
                    '#fd7e14',
                    '#e83e8c'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// 加载账号列表
async function loadAccounts() {
    try {
        const accounts = await apiRequest('/api/accounts');
        const select = document.getElementById('accountFilter');
        
        // 清空现有选项
        select.innerHTML = '<option value="">全部账号</option>';
        
        // 添加账号选项
        Object.entries(accounts).forEach(([accountId, account]) => {
            const option = document.createElement('option');
            option.value = accountId;
            option.textContent = `${account.name} (${accountId})`;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('加载账号列表失败:', error);
    }
}

// 加载统计数据
async function loadStatistics() {
    try {
        const params = new URLSearchParams();
        
        // 添加时间范围参数（UTC）
        const dateRange = document.getElementById('dateRange').value;
        if (dateRange === 'custom') {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
        } else {
            params.append('range', dateRange);
        }
        
        // 添加UTC时区参数
        params.append('timezone', 'UTC');
        
        // 添加账号筛选
        const accountFilter = document.getElementById('accountFilter').value;
        if (accountFilter) {
            params.append('self_id', accountFilter);
        }
        
        const stats = await apiRequest(`/api/statistics?${params.toString()}`);
        currentStats = stats;
        
        updateStatsCards(stats);
        updateCharts(stats);
        
    } catch (error) {
        console.error('加载统计数据失败:', error);
        showToast('加载统计数据失败', 'danger');
    }
}

// 更新统计卡片
function updateStatsCards(stats) {
    document.getElementById('total-messages').textContent = stats.total_messages || 0;
    document.getElementById('active-users').textContent = stats.active_users || 0;
    document.getElementById('active-groups').textContent = stats.active_groups || 0;
    document.getElementById('received-messages').textContent = stats.received_messages || 0;

    // 更新变化指示器
    updateChangeIndicator('messages-change', stats.messages_change);
    updateChangeIndicator('users-change', stats.users_change);
    updateChangeIndicator('groups-change', stats.groups_change);
    updateChangeIndicator('received-change', stats.received_change);
}

// 更新变化指示器
function updateChangeIndicator(elementId, change) {
    const element = document.getElementById(elementId);
    if (change === undefined || change === null) {
        element.textContent = '与昨日对比';
        element.className = 'text-muted';
        return;
    }

    const isPositive = change > 0;
    const icon = isPositive ? '↗' : '↘';
    const color = isPositive ? 'text-success' : 'text-danger';

    element.className = `text-muted ${color}`;
    element.textContent = `${icon} ${Math.abs(change)}`;
}

// 更新图表
function updateCharts(stats) {
    // 更新趋势图（每3小时）- 确保时间标签显示清晰
    if (stats.hourly_trend && stats.hourly_trend.length > 0) {
        messagesTrendChart.data.labels = stats.hourly_trend.map(item => item.time_label);
        messagesTrendChart.data.datasets[0].data = stats.hourly_trend.map(item => item.message_count);
        messagesTrendChart.update();
    }

    // 更新消息类型分布图 - 基于top_groups计算
    if (stats.top_groups && stats.total_messages) {
        const labels = [];
        const data = [];
        const colors = [];

        // 获取前5名群组
        const top10Groups = stats.top_groups.slice(0, 10);
        
        // 计算群聊总数（所有群组的消息总和）
        const totalGroupMessages = stats.top_groups.reduce((sum, group) => sum + group.message_count, 0);
        
        // 计算私聊数量（总消息数 - 群聊总数）
        const privateMessages = Math.max(0, stats.total_messages - totalGroupMessages);
        
        // 计算TOP5群组的消息总数
        const top10TotalMessages = top10Groups.reduce((sum, group) => sum + group.message_count, 0);
        
        // 计算其他群组的消息数量（总群聊 - TOP5群组）
        const otherGroupsMessages = Math.max(0, totalGroupMessages - top10TotalMessages);

        // 1. 添加私聊（如果有）
        if (privateMessages > 0) {
            labels.push('私聊');
            data.push(privateMessages);
            colors.push('#28a745'); // 绿色
        }

        // 2. 添加TOP10群组
        const groupColors = ['#20c997', '#6f42c1', '#fd7e14', '#e83e8c', '#6610f2', '#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8'];   
        top10Groups.forEach((group, index) => {
            labels.push(`群组 ${group.group_id}`);
            data.push(group.message_count);
            colors.push(groupColors[index % groupColors.length]);
        });

        // 3. 添加其他群组（如果有）
        if (otherGroupsMessages > 0) {
            labels.push('其他群组');
            data.push(otherGroupsMessages);
            colors.push('#6c757d'); // 灰色
        }

        // 4. 如果没有任何数据，显示占位符
        if (labels.length === 0) {
            labels.push('暂无数据');
            data.push(1);
            colors.push('#dee2e6');
        }

        // 更新图表
        messageTypeChart.data.labels = labels;
        messageTypeChart.data.datasets[0].data = data;
        messageTypeChart.data.datasets[0].backgroundColor = colors;
        messageTypeChart.update();
    }

    // 更新群组排行表格
    updateTopGroupsTable(stats);
}

// 群组活跃度表格更新函数 - 显示所有群组
function updateTopGroupsTable(stats) {
    const table = document.querySelector('#top-groups-table tbody');
    table.innerHTML = '';

    if (stats.top_groups && stats.top_groups.length > 0) {
        const allGroups = stats.top_groups.slice(0, 20);
        
        const totalGroupMessages = stats.top_groups.reduce((sum, group) => sum + group.message_count, 0);
        const firstPlaceCount = allGroups[0] ? allGroups[0].message_count : 1;

        allGroups.forEach((group, index) => {
            const row = document.createElement('tr');

            // 计算相对于总群聊消息的百分比
            const percentOfTotal = totalGroupMessages > 0 ? 
                Math.round((group.message_count / totalGroupMessages) * 100) : 0;
            
            // 计算相对于第一名的百分比
            const percentOfFirst = Math.round((group.message_count / firstPlaceCount) * 100);

            // 活跃度进度条颜色 - 根据排名分配颜色
            let progressColor;
            let badgeColor;
            
            if (index === 0) {
                progressColor = 'bg-success';
                badgeColor = 'bg-warning';
            } else if (index === 1) {
                progressColor = 'bg-info';
                badgeColor = 'bg-secondary';
            } else if (index === 2) {
                progressColor = 'bg-warning';
                badgeColor = 'bg-secondary';
            } else if (index < 10) {
                progressColor = 'bg-primary';
                badgeColor = 'bg-secondary';
            } else {
                progressColor = 'bg-secondary';
                badgeColor = 'bg-light text-dark';
            }

            // 特殊标记前三名
            let rankDisplay = `#${index + 1}`;
            if (index === 0) rankDisplay = '🥇 #1';
            else if (index === 1) rankDisplay = '🥈 #2';
            else if (index === 2) rankDisplay = '🥉 #3';

            row.innerHTML = `
                <td>
                    <span class="badge ${badgeColor}">${rankDisplay}</span>
                </td>
                <td><code>${group.group_id}</code></td>
                <td>
                    <strong>${group.message_count.toLocaleString()}</strong><small class="text-muted"> | ${percentOfTotal}% 总量</small>
                </td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar ${progressColor}" role="progressbar"
                             style="width: ${Math.max(percentOfFirst, 2)}%"
                             aria-valuenow="${percentOfFirst}" aria-valuemin="0" aria-valuemax="100">
                            ${percentOfFirst}%
                        </div>
                    </div>
                </td>
            `;

            // 为前三名添加特殊样式
            if (index < 3) {
                row.classList.add('table-light');
            }

            table.appendChild(row);
        });

    } else {
        // 没有数据时显示提示
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="4" class="text-center text-muted">
                <i class="bi bi-inbox"></i> 暂无群组活跃数据
            </td>
        `;
        table.appendChild(row);
    }
}


// 更新日期范围
function updateDateRange() {
    const dateRange = document.getElementById('dateRange').value;
    const customRange1 = document.getElementById('customDateRange');
    const customRange2 = document.getElementById('customDateRange2');
    
    if (dateRange === 'custom') {
        customRange1.style.display = 'block';
        customRange2.style.display = 'block';
        
        // 设置默认日期（UTC）
        const endDate = new Date();
        const startDate = new Date();
        startDate.setUTCDate(startDate.getUTCDate() - 7);
        
        document.getElementById('endDate').value = getUTCDateString(endDate);
        document.getElementById('startDate').value = getUTCDateString(startDate);
    } else {
        customRange1.style.display = 'none';
        customRange2.style.display = 'none';
    }
    
    loadStatistics();
}

// 刷新统计
function refreshStats() {
    loadStatistics();
    showToast('统计数据已刷新', 'success');
}

// 导出统计
function exportStats() {
    if (!currentStats || Object.keys(currentStats).length === 0) {
        showToast('暂无数据可导出', 'warning');
        return;
    }
    
    try {
        // 获取当前的筛选参数
        const dateRange = document.getElementById('dateRange').value;
        const accountFilter = document.getElementById('accountFilter').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        // 创建多个CSV内容
        const csvSections = [];
        
        // 1. 基础统计概览
        let overviewContent = "统计概览\n";
        overviewContent += "指标,数值\n";
        overviewContent += `发送消息数,${currentStats.total_messages || 0}\n`;
        overviewContent += `活跃用户数,${currentStats.active_users || 0}\n`;
        overviewContent += `活跃群组数,${currentStats.active_groups || 0}\n`;
        overviewContent += `收到消息数,${currentStats.received_messages || 0}\n`;
        overviewContent += `统计时间范围,${getDateRangeDescription()}\n`;
        overviewContent += `数据导出时间,${formatUTCTime(new Date().toISOString())}\n`;
        if (accountFilter) {
            const accountName = document.querySelector(`#accountFilter option[value="${accountFilter}"]`)?.textContent || accountFilter;
            overviewContent += `账号筛选,${accountName}\n`;
        }
        overviewContent += "\n";
        csvSections.push(overviewContent);
        
        // 2. 时间趋势数据（每3小时）
        if (currentStats.hourly_trend && currentStats.hourly_trend.length > 0) {
            let trendContent = "时间趋势（每3小时）\n";
            trendContent += "时间段,消息数量\n";
            currentStats.hourly_trend.forEach(item => {
                trendContent += `"${item.time_label}",${item.message_count}\n`;
            });
            trendContent += "\n";
            csvSections.push(trendContent);
        }
        
        // 3. 群组活跃度排行
        if (currentStats.top_groups && currentStats.top_groups.length > 0) {
            let groupsContent = "群组活跃度排行\n";
            groupsContent += "排名,群组ID,消息数量,占总量百分比\n";
            
            const totalGroupMessages = currentStats.top_groups.reduce((sum, group) => sum + group.message_count, 0);
            
            currentStats.top_groups.forEach((group, index) => {
                const percentage = totalGroupMessages > 0 ? 
                    ((group.message_count / totalGroupMessages) * 100).toFixed(2) : 0;
                groupsContent += `${index + 1},"${group.group_id}",${group.message_count},${percentage}%\n`;
            });
            groupsContent += "\n";
            csvSections.push(groupsContent);
        }
        
        // 4. 如果存在daily_details，也包含进去
        if (currentStats.daily_details && currentStats.daily_details.length > 0) {
            let dailyContent = "每日详细数据\n";
            dailyContent += "日期,消息数,用户数,群组数,指令数\n";
            currentStats.daily_details.forEach(day => {
                dailyContent += `${day.date},${day.messages || 0},${day.users || 0},${day.groups || 0},${day.commands || 0}\n`;
            });
            dailyContent += "\n";
            csvSections.push(dailyContent);
        }
        
        // 5. 如果存在消息类型分布数据
        if (currentStats.message_types && Object.keys(currentStats.message_types).length > 0) {
            let typesContent = "消息类型分布\n";
            typesContent += "消息类型,数量,占比\n";
            const totalMessages = Object.values(currentStats.message_types).reduce((sum, count) => sum + count, 0);
            
            Object.entries(currentStats.message_types).forEach(([type, count]) => {
                const percentage = totalMessages > 0 ? ((count / totalMessages) * 100).toFixed(2) : 0;
                typesContent += `"${type}",${count},${percentage}%\n`;
            });
            typesContent += "\n";
            csvSections.push(typesContent);
        }
        
        // 合并所有CSV内容
        const fullCsvContent = csvSections.join("");
        
        // 创建Blob并下载
        const blob = new Blob(['\ufeff' + fullCsvContent], { 
            type: 'text/csv;charset=utf-8;' 
        });
        
        // 生成文件名
        const fileName = generateFileName();
        
        // 使用现代下载方式
        if (window.navigator && window.navigator.msSaveOrOpenBlob) {
            // IE浏览器
            window.navigator.msSaveOrOpenBlob(blob, fileName);
        } else {
            // 现代浏览器
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // 清理URL对象
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }
        
        showToast(`统计数据已导出为 ${fileName}`, 'success');
        
    } catch (error) {
        console.error('导出统计数据失败:', error);
        showToast('导出统计数据失败，请重试', 'danger');
    }
}

// 生成文件名的辅助函数
function generateFileName() {
    const dateRange = document.getElementById('dateRange').value;
    const accountFilter = document.getElementById('accountFilter').value;
    const currentDate = getCurrentUTCDate();
    
    let fileName = `BotShepherd_统计_${currentDate}_UTC`;
    
    // 添加时间范围标识
    switch(dateRange) {
        case 'today':
            fileName += '_今日';
            break;
        case 'yesterday':
            fileName += '_昨日';
            break;
        case 'week':
            fileName += '_7天';
            break;
        case 'month':
            fileName += '_30天';
            break;
        case 'custom':
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            if (start && end) {
                fileName += `_${start}_to_${end}`;
            } else {
                fileName += '_自定义';
            }
            break;
    }
    
    // 添加账号标识
    if (accountFilter) {
        fileName += `_账号${accountFilter}`;
    }
    
    return fileName + '.csv';
}

// 获取日期范围描述的辅助函数
function getDateRangeDescription() {
    const dateRange = document.getElementById('dateRange').value;
    
    switch(dateRange) {
        case 'today':
            return `今日 (${getCurrentUTCDate()})`;
        case 'yesterday':
            return `昨日 (${getYesterdayUTCDate()})`;
        case 'week':
            return `最近7天 (${getUTCDateBefore(7)} 至 ${getCurrentUTCDate()})`;
        case 'month':
            return `最近30天 (${getUTCDateBefore(30)} 至 ${getCurrentUTCDate()})`;
        case 'custom':
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            if (start && end) {
                return `自定义范围 (${start} 至 ${end})`;
            } else {
                return '自定义范围';
            }
        default:
            return '未知范围';
    }
}
</script>
{% endblock %}